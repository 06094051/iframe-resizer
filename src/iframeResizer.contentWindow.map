{"version":3,"file":"iframeResizer.contentWindow.min.js","sources":["iframeResizer.contentWindow.js"],"names":["addEventListener","el","evt","func","window","attachEvent","formatLogMsg","msg","msgID","myID","log","logging","console","warn","init","readData","setMargin","setBodyStyle","bodyBackground","bodyPadding","injectClearFixIntoBodyElement","checkHeightMode","stopInfiniteResizingOfIFrame","setupPublicMethods","startEventListeners","inPageLinks","setupInPageLinks","sendSize","strBool","str","data","initMsg","substr","msgIdLen","split","bodyMargin","undefined","Number","calculateWidth","interval","publicMethods","autoResize","bodyMarginStr","heightCalcMode","tolerance","chkCSS","attr","value","indexOf","document","body","style","documentElement","height","initWindowResizeListener","initWindowClickListener","heightCalcModeDefault","getHeight","setupMutationObserver","clearFix","createElement","clear","display","appendChild","getPagePosition","x","pageXOffset","scrollLeft","y","pageYOffset","scrollTop","getElementPosition","elPosition","getBoundingClientRect","pagePosition","parseInt","left","top","findTarget","href","jumpToTaget","target","jumpPosition","sendMsg","querySelector","checkLocationHash","hash","location","bindAnchors","setupLink","linkClicked","e","preventDefault","this","getAttribute","Array","prototype","forEach","call","querySelectorAll","bindLocationHash","initCheck","setTimeout","eventCancelTimer","parentIFrame","close","getId","moveToAnchor","reset","resetIFrame","scrollTo","scrollToOffset","sendMessage","targetOrigin","setHeightCalculationMethod","heightCalculationMethod","setTargetOrigin","targetOriginDefault","size","customHeight","customWidth","valString","lockTrigger","initInterval","setInterval","Math","abs","setupInjectElementLoadListners","mutations","addLoadListener","element","width","src","mutation","type","attributeName","images","image","createMutationObserver","config","attributes","attributeOldValue","characterData","characterDataOldValue","childList","subtree","observer","MutationObserver","observe","WebKitMutationObserver","getBodyOffsetHeight","getComputedBodyStyle","prop","convertUnitsToPxForIE8","PIXEL","test","base","runtimeStyle","currentStyle","pixelLeft","retVal","defaultView","getComputedStyle","offsetHeight","getBodyScrollHeight","scrollHeight","getDEOffsetHeight","getDEScrollHeight","getLowestElementHeight","allElements","allElementsLength","length","maxBottomVal","timer","Date","getTime","i","bottom","getAllHeights","getMaxHeight","max","apply","getMinHeight","min","getBestHeight","getWidth","scrollWidth","triggerEvent","triggerEventDesc","recordTrigger","resetPage","resizeIFrame","currentHeight","currentWidth","isDoubleFiredEvent","triggerLocked","doubleEventList","isSizeChangeDetected","checkTolarance","a","b","isForceResizableEvent","isForceResizableHeightCalcMode","resetRequiredMethods","logIgnored","checkDownSizing","clearTimeout","triggerLockedTimer","triggerReset","hcm","sendToParent","message","postMessage","receiver","event","isMessageForUs","initFromParent","source","firstRun","initLock","resetFromParent","getMessageType","isMiddleTier","isInitMsg","true","false","resize","click","scroll","bodyScroll","documentElementScroll","parent","offset","bodyOffset","documentElementOffset","grow","lowestElement"],"mappings":"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","sourcesContent":["/*\n * File: iframeSizer.contentWindow.js\n * Desc: Include this file in any page being loaded into an iframe\n *       to force the iframe to resize to the content size.\n * Requires: iframeResizer.js on host page.\n * Author: David J. Bradshaw - dave@bradshaw.net\n * Contributor: Jure Mav - jure.mav@gmail.com\n */\n\n;(function() {\n\t'use strict';\n\n\tvar\n\t\tautoResize            = true,\n\t\tbase                  = 10,\n\t\tbodyBackground        = '',\n\t\tbodyMargin            = 0,\n\t\tbodyMarginStr         = '',\n\t\tbodyPadding           = '',\n\t\tcalculateWidth        = false,\n\t\tdoubleEventList       = {'resize':1,'click':1},\n\t\teventCancelTimer      = 128,\n\t\theight                = 1,\n\t\tfirstRun              = true,\n\t\theightCalcModeDefault = 'offset',\n\t\theightCalcMode        = heightCalcModeDefault,\n\t\tinitLock              = true,\n\t\tinitMsg               = '',\n\t\tinPageLinks           = {},\n\t\tinterval              = 32,\n\t\tlogging               = false,\n\t\tmsgID                 = '[iFrameSizer]',  //Must match host page msg ID\n\t\tmsgIdLen              = msgID.length,\n\t\tmyID                  = '',\n\t\tpublicMethods         = false,\n\t\tresetRequiredMethods  = {max:1,scroll:1,bodyScroll:1,documentElementScroll:1},\n\t\ttargetOriginDefault   = '*',\n\t\ttarget                = window.parent,\n\t\ttolerance             = 0,\n\t\ttriggerLocked         = false,\n\t\ttriggerLockedTimer    = null,\n\t\twidth                 = 1;\n\n\n\tfunction addEventListener(el,evt,func){\n\t\tif ('addEventListener' in window){\n\t\t\tel.addEventListener(evt,func, false);\n\t\t} else if ('attachEvent' in window){ //IE\n\t\t\tel.attachEvent('on'+evt,func);\n\t\t}\n\t}\n\n\tfunction formatLogMsg(msg){\n\t\treturn msgID + '[' + myID + ']' + ' ' + msg;\n\t}\n\n\tfunction log(msg){\n\t\tif (logging && ('object' === typeof window.console)){\n\t\t\tconsole.log(formatLogMsg(msg));\n\t\t}\n\t}\n\n\tfunction warn(msg){\n\t\tif ('object' === typeof window.console){\n\t\t\tconsole.warn(formatLogMsg(msg));\n\t\t}\n\t}\n\n\n\tfunction init(){\n\t\tlog('Initialising iFrame');\n\t\treadData();\n\t\tsetMargin();\n\t\tsetBodyStyle('background',bodyBackground);\n\t\tsetBodyStyle('padding',bodyPadding);\n\t\tinjectClearFixIntoBodyElement();\n\t\tcheckHeightMode();\n\t\tstopInfiniteResizingOfIFrame();\n\t\tsetupPublicMethods();\n\t\tstartEventListeners();\n\t\tinPageLinks = setupInPageLinks();\n\t\tsendSize('init','Init message from host page');\n\t}\n\n\tfunction readData(){\n\n\t\tvar data = initMsg.substr(msgIdLen).split(':');\n\n\t\tfunction strBool(str){\n\t\t\treturn 'true' === str ? true : false;\n\t\t}\n\n\t\tmyID             = data[0];\n\t\tbodyMargin       = (undefined !== data[1]) ? Number(data[1])   : bodyMargin; //For V1 compatibility\n\t\tcalculateWidth   = (undefined !== data[2]) ? strBool(data[2])  : calculateWidth;\n\t\tlogging          = (undefined !== data[3]) ? strBool(data[3])  : logging;\n\t\tinterval         = (undefined !== data[4]) ? Number(data[4])   : interval;\n\t\tpublicMethods    = (undefined !== data[5]) ? strBool(data[5])  : publicMethods;\n\t\tautoResize       = (undefined !== data[6]) ? strBool(data[6])  : autoResize;\n\t\tbodyMarginStr    = data[7];\n\t\theightCalcMode   = (undefined !== data[8]) ? data[8]           : heightCalcMode;\n\t\tbodyBackground   = data[9];\n\t\tbodyPadding      = data[10];\n\t\ttolerance        = (undefined !== data[11]) ? Number(data[11]) : tolerance;\n\t}\n\n\tfunction chkCSS(attr,value){\n\t\tif (-1 !== value.indexOf('-')){\n\t\t\twarn('Negative CSS value ignored for '+attr);\n\t\t\tvalue='';\n\t\t}\n\t\treturn value;\n\t}\n\n\tfunction setBodyStyle(attr,value){\n\t\tif ((undefined !== value) && ('' !== value) && ('null' !== value)){\n\t\t\tdocument.body.style[attr] = value;\n\t\t\tlog('Body '+attr+' set to \"'+value+'\"');\n\t\t}\n\t}\n\n\tfunction setMargin(){\n\t\t//If called via V1 script, convert bodyMargin from int to str \n\t\tif (undefined === bodyMarginStr){\n\t\t\tbodyMarginStr = bodyMargin+'px';\n\t\t}\n\t\tchkCSS('margin',bodyMarginStr);\n\t\tsetBodyStyle('margin',bodyMarginStr);\n\t}\n\n\tfunction stopInfiniteResizingOfIFrame(){\n\t\tdocument.documentElement.style.height = '';\n\t\tdocument.body.style.height = '';\n\t\tlog('HTML & body height set to \"auto\"');\n\t}\n\n\tfunction initWindowResizeListener(){\n\t\taddEventListener(window,'resize', function(){\n\t\t\tsendSize('resize','Window resized');\n\t\t});\n\t}\n\n\tfunction initWindowClickListener(){\n\t\taddEventListener(window,'click', function(){\n\t\t\tsendSize('click','Window clicked');\n\t\t});\n\t}\n\n\tfunction checkHeightMode(){\n\t\tif (heightCalcModeDefault !== heightCalcMode){\n\t\t\tif (!(heightCalcMode in getHeight)){\n\t\t\t\twarn(heightCalcMode + ' is not a valid option for heightCalculationMethod.');\n\t\t\t\theightCalcMode='bodyScroll';\n\t\t\t}\n\t\t\tlog('Height calculation method set to \"'+heightCalcMode+'\"');\n\t\t}\n\t}\n\n\tfunction startEventListeners(){\n\t\tif ( true === autoResize ) {\n\t\t\tinitWindowResizeListener();\n\t\t\tinitWindowClickListener();\n\t\t\tsetupMutationObserver();\n\t\t}\n\t\telse {\n\t\t\tlog('Auto Resize disabled');\n\t\t}\n\t}\n\n\tfunction injectClearFixIntoBodyElement(){\n\t\tvar clearFix = document.createElement('div');\n\t\tclearFix.style.clear = 'both';\n\t\tclearFix.style.display = 'block'; //Guard against this having been globally redefined in CSS.\n\t\tdocument.body.appendChild(clearFix);\n\t}\n\n\tfunction setupInPageLinks(){\n\n\t\tfunction getPagePosition (){\n\t\t\treturn {\n\t\t\t\tx: (window.pageXOffset !== undefined) ? window.pageXOffset : document.documentElement.scrollLeft,\n\t\t\t\ty: (window.pageYOffset !== undefined) ? window.pageYOffset : document.documentElement.scrollTop\n\t\t\t};\n\t\t}\n\n\t\tfunction getElementPosition(el){\n\t\t\tvar\n\t\t\t\telPosition   = el.getBoundingClientRect(),\n\t\t\t\tpagePosition = getPagePosition();\n \n\t\t\treturn {\n\t\t\t\tx: parseInt(elPosition.left,10) + parseInt(pagePosition.x,10),\n\t\t\t\ty: parseInt(elPosition.top,10)  + parseInt(pagePosition.y,10)\n\t\t\t};\n\t\t}\n\n\t\tfunction findTarget(href){\n\t\t\tfunction jumpToTaget(target){\n\t\t\t\tvar jumpPosition = getElementPosition(target);\n\n\t\t\t\tlog('Moving to in page link ('+href+') at x: '+jumpPosition.x+' y: '+jumpPosition.y);\n\t\t\t\tsendMsg(jumpPosition.y, jumpPosition.x, 'scrollToOffset'); // X&Y reversed at sendMsg uses height/width\n\t\t\t}\n\n\t\t\tvar\ttarget = document.querySelector(href) || document.querySelector('[name=\"'+href.substr(1,999)+'\"]');\n\t\t\t\t\n\t\t\tif (null !== target){\n\t\t\t\tjumpToTaget(target);\n\t\t\t} else {\n\t\t\t\tlog('In page link (' + href + ') not found in iFrame, so sending to parent');\n\t\t\t\tsendMsg(0,0,'inPageLink',href);\n\t\t\t}\n\t\t}\n\n\t\tfunction checkLocationHash(){\n\t\t\tvar hash = location.hash;\n\n\t\t\tif ('' !== hash && '#' !== hash){\n\t\t\t\tfindTarget(hash);\n\t\t\t}\n\t\t}\n\n\t\tfunction bindAnchors(){\n\t\t\tfunction setupLink(el){\n\t\t\t\tfunction linkClicked(e){\n\t\t\t\t\te.preventDefault();\n\n\t\t\t\t\t/*jshint validthis:true */\n\t\t\t\t\tfindTarget(this.getAttribute('href'));\n\t\t\t\t}\n\n\t\t\t\tif ('#' !== el.getAttribute('href')){\n\t\t\t\t\taddEventListener(el,'click',linkClicked);\n\t\t\t\t}\n\t\t\t}\n\t\t\n\t\t\tArray.prototype.forEach.call( document.querySelectorAll( 'a[href^=\"#\"]' ), setupLink );\n\t\t}\n\n\t\tfunction bindLocationHash(){\n\t\t\taddEventListener(window,'hashchange',checkLocationHash);\n\t\t}\n\n\t\tfunction initCheck(){ //check if page loaded with location hash after init resize\n\t\t\tsetTimeout(checkLocationHash,eventCancelTimer);\n\t\t}\n\n\t\tif(Array.prototype.forEach && document.querySelectorAll){\n\t\t\tlog('Setting up location.hash handlers');\n\t\t\tbindAnchors();\n\t\t\tbindLocationHash();\n\t\t\tinitCheck();\n\t\t} else {\n\t\t\twarn('In page linking not fully supported in this browser! (See README.md for IE8 workaround)');\n\t\t}\n\n\t\treturn {\n\t\t\tfindTarget:findTarget\n\t\t};\n\t}\n\n\tfunction setupPublicMethods(){\n\t\tif (publicMethods) {\n\t\t\tlog('Enable public methods');\n\n\t\t\twindow.parentIFrame = {\n\t\t\t\tclose: function closeF(){\n\t\t\t\t\tsendSize('close','parentIFrame.close()', 0, 0);\n\t\t\t\t},\n\t\t\t\tgetId: function getIdF(){\n\t\t\t\t\treturn myID;\n\t\t\t\t},\n\t\t\t\tmoveToAnchor: function moveToAnchorF(hash){\n\t\t\t\t\tinPageLinks.findTarget(hash);\n\t\t\t\t},\n\t\t\t\treset: function resetF(){\n\t\t\t\t\tresetIFrame('parentIFrame.reset');\n\t\t\t\t},\n\t\t\t\tscrollTo: function scrollToF(x,y){\n\t\t\t\t\tsendMsg(y,x,'scrollTo'); // X&Y reversed at sendMsg uses height/width\n\t\t\t\t},\n\t\t\t\tscrollToOffset: function scrollToF(x,y){\n\t\t\t\t\tsendMsg(y,x,'scrollToOffset'); // X&Y reversed at sendMsg uses height/width\n\t\t\t\t},\n\t\t\t\tsendMessage: function sendMessageF(msg,targetOrigin){\n\t\t\t\t\tsendMsg(0,0,'message',msg,targetOrigin);\n\t\t\t\t},\n\t\t\t\tsetHeightCalculationMethod: function setHeightCalculationMethodF(heightCalculationMethod){\n\t\t\t\t\theightCalcMode = heightCalculationMethod;\n\t\t\t\t\tcheckHeightMode();\n\t\t\t\t},\n\t\t\t\tsetTargetOrigin: function setTargetOriginF(targetOrigin){\n\t\t\t\t\tlog('Set targetOrigin: '+targetOrigin);\n\t\t\t\t\ttargetOriginDefault = targetOrigin;\n\t\t\t\t},\n\t\t\t\tsize: function sizeF(customHeight, customWidth){\n\t\t\t\t\tvar valString = ''+(customHeight?customHeight:'')+(customWidth?','+customWidth:'');\n\t\t\t\t\tlockTrigger();\n\t\t\t\t\tsendSize('size','parentIFrame.size('+valString+')', customHeight, customWidth);\n\t\t\t\t}\n\t\t\t};\n\t\t}\n\t}\n\n\tfunction initInterval(){\n\t\tif ( 0 !== interval ){\n\t\t\tlog('setInterval: '+interval+'ms');\n\t\t\tsetInterval(function(){\n\t\t\t\tsendSize('interval','setInterval: '+interval);\n\t\t\t},Math.abs(interval));\n\t\t}\n\t}\n\n\tfunction setupInjectElementLoadListners(mutations){\n\t\tfunction addLoadListener(element){\n\t\t\tif (element.height === undefined || element.width === undefined || 0 === element.height || 0 === element.width){\n\t\t\t\tlog('Attach listerner to '+element.src);\n\t\t\t\taddEventListener(element,'load', function imageLoaded(){\n\t\t\t\t\tsendSize('imageLoad','Image loaded');\n\t\t\t\t});\n\t\t\t}\n\t\t}\n\n\t\tmutations.forEach(function (mutation) {\n\t\t\tif (mutation.type === 'attributes' && mutation.attributeName === 'src'){\n\t\t\t\taddLoadListener(mutation.target);\n\t\t\t} else if (mutation.type === 'childList'){\n\t\t\t\tvar images = mutation.target.querySelectorAll('img');\n\t\t\t\tArray.prototype.forEach.call(images,function (image) {\n\t\t\t\t\taddLoadListener(image);\n\t\t\t\t});\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction setupMutationObserver(){\n\n\t\tvar MutationObserver = window.MutationObserver || window.WebKitMutationObserver;\n\n\t\tfunction createMutationObserver(){\n\t\t\tvar\n\t\t\t\ttarget = document.querySelector('body'),\n\n\t\t\t\tconfig = {\n\t\t\t\t\tattributes            : true,\n\t\t\t\t\tattributeOldValue     : false,\n\t\t\t\t\tcharacterData         : true,\n\t\t\t\t\tcharacterDataOldValue : false,\n\t\t\t\t\tchildList             : true,\n\t\t\t\t\tsubtree               : true\n\t\t\t\t},\n\n\t\t\t\tobserver = new MutationObserver(function(mutations) {\n\t\t\t\t\tsendSize('mutationObserver','mutationObserver: ' + mutations[0].target + ' ' + mutations[0].type);\n\t\t\t\t\tsetupInjectElementLoadListners(mutations); //Deal with WebKit asyncing image loading when tags are injected into the page\n\t\t\t\t});\n\n\t\t\tlog('Enable MutationObserver');\n\t\t\tobserver.observe(target, config);\n\t\t}\n\n\t\tif (MutationObserver){\n\t\t\tif (0 > interval) {\n\t\t\t\tinitInterval();\n\t\t\t} else {\n\t\t\t\tcreateMutationObserver();\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\twarn('MutationObserver not supported in this browser!');\n\t\t\tinitInterval();\n\t\t}\n\t}\n\n\n\t// document.documentElement.offsetHeight is not reliable, so\n\t// we have to jump through hoops to get a better value.\n\tfunction getBodyOffsetHeight(){\n\t\tfunction getComputedBodyStyle(prop) {\n\t\t\tfunction convertUnitsToPxForIE8(value) {\n\t\t\t\tvar PIXEL = /^\\d+(px)?$/i;\n\n\t\t\t\tif (PIXEL.test(value)) {\n\t\t\t\t\treturn parseInt(value,base);\n\t\t\t\t}\n\n\t\t\t\tvar\n\t\t\t\t\tstyle = el.style.left,\n\t\t\t\t\truntimeStyle = el.runtimeStyle.left;\n\n\t\t\t\tel.runtimeStyle.left = el.currentStyle.left;\n\t\t\t\tel.style.left = value || 0;\n\t\t\t\tvalue = el.style.pixelLeft;\n\t\t\t\tel.style.left = style;\n\t\t\t\tel.runtimeStyle.left = runtimeStyle;\n\n\t\t\t\treturn value;\n\t\t\t}\n\n\t\t\tvar\n\t\t\t\tel = document.body,\n\t\t\t\tretVal = 0;\n\n\t\t\tif (('defaultView' in document) && ('getComputedStyle' in document.defaultView)) {\n\t\t\t\tretVal = document.defaultView.getComputedStyle(el, null);\n\t\t\t\tretVal = (null !== retVal) ? retVal[prop] : 0;\n\t\t\t} else {//IE8\n\t\t\t\tretVal =  convertUnitsToPxForIE8(el.currentStyle[prop]);\n\t\t\t}\n\n\t\t\treturn parseInt(retVal,base);\n\t\t}\n\n\t\treturn  document.body.offsetHeight +\n\t\t\t\tgetComputedBodyStyle('marginTop') +\n\t\t\t\tgetComputedBodyStyle('marginBottom');\n\t}\n\n\tfunction getBodyScrollHeight(){\n\t\treturn document.body.scrollHeight;\n\t}\n\n\tfunction getDEOffsetHeight(){\n\t\treturn document.documentElement.offsetHeight;\n\t}\n\n\tfunction getDEScrollHeight(){\n\t\treturn document.documentElement.scrollHeight;\n\t}\n\n\t//From https://github.com/guardian/iframe-messenger\n\tfunction getLowestElementHeight() {\n\t\tvar\n\t\t\tallElements       = document.querySelectorAll('body *'),\n\t\t\tallElementsLength = allElements.length,\n\t\t\tmaxBottomVal      = 0,\n\t\t\ttimer             = new Date().getTime();\n\n\t\tfor (var i = 0; i < allElementsLength; i++) {\n\t\t\tif (allElements[i].getBoundingClientRect().bottom > maxBottomVal) {\n\t\t\t\tmaxBottomVal = allElements[i].getBoundingClientRect().bottom;\n\t\t\t}\n\t\t}\n\n\t\ttimer = new Date().getTime() - timer;\n\n\t\tlog('Parsed '+allElementsLength+' HTML elements');\n\t\tlog('LowestElement bottom position calculated in ' + timer + 'ms');\n\n\t\treturn maxBottomVal;\n\t}\n\n\tfunction getAllHeights(){\n\t\treturn [\n\t\t\tgetBodyOffsetHeight(),\n\t\t\tgetBodyScrollHeight(),\n\t\t\tgetDEOffsetHeight(),\n\t\t\tgetDEScrollHeight()\n\t\t];\n\t}\n\n\tfunction getMaxHeight(){\n\t\treturn Math.max.apply(null,getAllHeights());\n\t}\n\n\tfunction getMinHeight(){\n\t\treturn Math.min.apply(null,getAllHeights());\n\t}\n\n\tfunction getBestHeight(){\n\t\treturn Math.max(getBodyOffsetHeight(),getLowestElementHeight());\n\t}\n\n\tvar getHeight = {\n\t\toffset                : getBodyOffsetHeight, //Backward compatability\n\t\tbodyOffset            : getBodyOffsetHeight,\n\t\tbodyScroll            : getBodyScrollHeight,\n\t\tdocumentElementOffset : getDEOffsetHeight,\n\t\tscroll                : getDEScrollHeight, //Backward compatability\n\t\tdocumentElementScroll : getDEScrollHeight,\n\t\tmax                   : getMaxHeight,\n\t\tmin                   : getMinHeight,\n\t\tgrow                  : getMaxHeight,\n\t\tlowestElement         : getBestHeight\n\t};\n\n\tfunction getWidth(){\n\t\treturn Math.max(\n\t\t\tdocument.documentElement.scrollWidth,\n\t\t\tdocument.body.scrollWidth\n\t\t);\n\t}\n\n\tfunction sendSize(triggerEvent, triggerEventDesc, customHeight, customWidth){\n\n\t\tvar\tcurrentHeight,currentWidth;\n\n\t\tfunction recordTrigger(){\n\t\t\tif (!(triggerEvent in {'reset':1,'resetPage':1,'init':1})){\n\t\t\t\tlog( 'Trigger event: ' + triggerEventDesc );\n\t\t\t}\n\t\t}\n\n\t\tfunction resizeIFrame(){\n\t\t\theight = currentHeight;\n\t\t\twidth  = currentWidth;\n\n\t\t\tsendMsg(height,width,triggerEvent);\n\t\t}\n\n\t\tfunction isDoubleFiredEvent(){\n\t\t\treturn  triggerLocked && (triggerEvent in doubleEventList);\n\t\t}\n\n\t\tfunction isSizeChangeDetected(){\n\t\t\tfunction checkTolarance(a,b){\n\t\t\t\tvar retVal = Math.abs(a-b) <= tolerance;\n\t\t\t\treturn !retVal;\n\t\t\t}\n\n\t\t\tcurrentHeight = (undefined !== customHeight)  ? customHeight : getHeight[heightCalcMode]();\n\t\t\tcurrentWidth  = (undefined !== customWidth )  ? customWidth  : getWidth();\n\n\t\t\treturn\tcheckTolarance(height,currentHeight) ||\n\t\t\t\t\t(calculateWidth && checkTolarance(width,currentWidth));\n\n\t\t\t//return\t(height !== currentHeight) ||\n\t\t\t//\t\t(calculateWidth && width !== currentWidth);\n\t\t}\n\n\t\tfunction isForceResizableEvent(){\n\t\t\treturn !(triggerEvent in {'init':1,'interval':1,'size':1});\n\t\t}\n\n\t\tfunction isForceResizableHeightCalcMode(){\n\t\t\treturn (heightCalcMode in resetRequiredMethods);\n\t\t}\n\n\t\tfunction logIgnored(){\n\t\t\tlog('No change in size detected');\n\t\t}\n\n\t\tfunction checkDownSizing(){\n\t\t\tif (isForceResizableEvent() && isForceResizableHeightCalcMode()){\n\t\t\t\tresetIFrame(triggerEventDesc);\n\t\t\t} else if (!(triggerEvent in {'interval':1})){\n\t\t\t\trecordTrigger();\n\t\t\t\tlogIgnored();\n\t\t\t}\n\t\t}\n\n\t\tif (!isDoubleFiredEvent()){\n\t\t\tif (isSizeChangeDetected()){\n\t\t\t\trecordTrigger();\n\t\t\t\tlockTrigger();\n\t\t\t\tresizeIFrame();\n\t\t\t} else {\n\t\t\t\tcheckDownSizing();\n\t\t\t}\n\t\t} else {\n\t\t\tlog('Trigger event cancelled: '+triggerEvent);\n\t\t}\n\t}\n\n\tfunction lockTrigger(){\n\t\tif (!triggerLocked){\n\t\t\ttriggerLocked = true;\n\t\t\tlog('Trigger event lock on');\n\t\t}\n\t\tclearTimeout(triggerLockedTimer);\n\t\ttriggerLockedTimer = setTimeout(function(){\n\t\t\ttriggerLocked = false;\n\t\t\tlog('Trigger event lock off');\n\t\t\tlog('--');\n\t\t},eventCancelTimer);\n\t}\n\n\tfunction triggerReset(triggerEvent){\n\t\theight = getHeight[heightCalcMode]();\n\t\twidth  = getWidth();\n\n\t\tsendMsg(height,width,triggerEvent);\n\t}\n\n\tfunction resetIFrame(triggerEventDesc){\n\t\tvar hcm = heightCalcMode;\n\t\theightCalcMode = heightCalcModeDefault;\n\n\t\tlog('Reset trigger event: ' + triggerEventDesc);\n\t\tlockTrigger();\n\t\ttriggerReset('reset');\n\n\t\theightCalcMode = hcm;\n\t}\n\n\tfunction sendMsg(height,width,triggerEvent,msg,targetOrigin){\n\t\tfunction setTargetOrigin(){\n\t\t\tif (undefined === targetOrigin){\n\t\t\t\ttargetOrigin = targetOriginDefault;\n\t\t\t} else {\n\t\t\t\tlog('Message targetOrigin: '+targetOrigin);\n\t\t\t}\n\t\t}\n\n\t\tfunction sendToParent(){\n\t\t\tvar\n\t\t\t\tsize  = height + ':' + width,\n\t\t\t\tmessage = myID + ':' +  size + ':' + triggerEvent + (undefined !== msg ? ':' + msg : '');\n\n\t\t\tlog('Sending message to host page (' + message + ')');\n\t\t\ttarget.postMessage( msgID + message, targetOrigin);\n\t\t}\n\n\t\tsetTargetOrigin();\n\t\tsendToParent();\n\t}\n\n\tfunction receiver(event) {\n\t\tfunction isMessageForUs(){\n\t\t\treturn msgID === (''+event.data).substr(0,msgIdLen); //''+ Protects against non-string messages\n\t\t}\n\n\t\tfunction initFromParent(){\n\t\t\tinitMsg = event.data;\n\t\t\ttarget  = event.source;\n\n\t\t\tinit();\n\t\t\tfirstRun = false;\n\t\t\tsetTimeout(function(){ initLock = false;},eventCancelTimer);\n\t\t}\n\n\t\tfunction resetFromParent(){\n\t\t\tif (!initLock){\n\t\t\t\tlog('Page size reset by host page');\n\t\t\t\ttriggerReset('resetPage');\n\t\t\t} else {\n\t\t\t\tlog('Page reset ignored by init');\n\t\t\t}\n\t\t}\n\n\t\tfunction getMessageType(){\n\t\t\treturn event.data.split(']')[1];\n\t\t}\n\n\t\tfunction isMiddleTier(){\n\t\t\treturn ('iFrameResize' in window);\n\t\t}\n\n\t\tfunction isInitMsg(){\n\t\t\t//test if this message is from a child below us. This is an ugly test, however, updating\n\t\t\t//the message format would break backwards compatibity.\n\t\t\treturn event.data.split(':')[2] in {'true':1,'false':1};\n\t\t}\n\n\t\tif (isMessageForUs()){\n\t\t\tif (firstRun && isInitMsg()){ //Check msg ID\n\t\t\t\tinitFromParent();\n\t\t\t} else if ('reset' === getMessageType()){\n\t\t\t\tresetFromParent();\n\t\t\t} else if (event.data !== initMsg && !isMiddleTier()){\n\t\t\t\twarn('Unexpected message ('+event.data+')');\n\t\t\t}\n\t\t}\n\t}\n\n\taddEventListener(window, 'message', receiver);\n\n})();\n"]}